<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPU Specifications - Visualizations</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .nav {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .nav a {
            color: #667eea;
            text-decoration: none;
            margin-right: 20px;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav a:hover {
            color: #764ba2;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .control-group select {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        #cpu1Select:focus, #cpu2Select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-chip {
            padding: 8px 16px;
            background: #f1f5f9;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .filter-chip:hover {
            background: #e2e8f0;
        }

        .filter-chip.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        #chart {
            min-height: 600px;
            width: 100%;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“Š CPU Specifications Visualizations</h1>
        <p>Interactive charts and analysis of CPU performance metrics</p>
    </div>

    <div class="nav">
        <a href="/">ðŸ“‹ Table View</a>
        <a href="/visualizations">ðŸ“Š Visualizations</a>
        <a href="/docs">ðŸ“š API Docs</a>
    </div>

    <div class="container">
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalCpus">-</div>
                <div class="stat-label">Total CPUs</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgTdp">-</div>
                <div class="stat-label">Avg TDP (W)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgCores">-</div>
                <div class="stat-label">Avg Cores</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgFreq">-</div>
                <div class="stat-label">Avg Frequency (GHz)</div>
            </div>
        </div>

        <div class="controls">
            <div class="controls-grid">
                <div class="control-group">
                    <label for="xAxis">X-Axis Parameter</label>
                    <select id="xAxis">
                        <option value="tdp_watts">TDP (W)</option>
                        <option value="max_turbo_frequency_ghz">Max Turbo Frequency (GHz)</option>
                        <option value="cores">Cores</option>
                        <option value="threads">Threads</option>
                        <option value="l3_cache_mb">L3 Cache (MB)</option>
                        <option value="max_memory_tb">Max Memory (TB)</option>
                        <option value="launch_year">Launch Year</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="yAxis">Y-Axis Parameter</label>
                    <select id="yAxis">
                        <option value="max_turbo_frequency_ghz">Max Turbo Frequency (GHz)</option>
                        <option value="tdp_watts">TDP (W)</option>
                        <option value="cores">Cores</option>
                        <option value="threads">Threads</option>
                        <option value="l3_cache_mb">L3 Cache (MB)</option>
                        <option value="max_memory_tb">Max Memory (TB)</option>
                        <option value="launch_year">Launch Year</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="chartType">Chart Type</label>
                    <select id="chartType">
                        <option value="scatter">Scatter Plot</option>
                        <option value="bar">Bar Chart</option>
                        <option value="box">Box Plot</option>
                    </select>
                </div>

                <div class="control-group" id="barLimitGroup" style="display: none;">
                    <label for="barLimit">Number of CPUs to Display</label>
                    <input type="number" id="barLimit" min="5" max="100" value="25" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
            </div>

            <div class="filter-group">
                <label style="font-weight: 600; margin-right: 10px;">Filter by Family:</label>
                <div id="familyFilters"></div>
            </div>

            <div class="filter-group" style="margin-top: 15px;">
                <label style="font-weight: 600; margin-right: 10px;">Filter by Codename:</label>
                <div id="codenameFilters"></div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title" id="chartTitle">Loading data...</div>
            <div id="chart">
                <div class="loading">Loading chart data...</div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title" style="text-align: center; margin-bottom: 30px;">CPU Comparison Tool</div>
            <div class="comparison-controls" style="max-width: 800px; margin: 0 auto 30px;">
                <div class="comparison-selectors" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="comparison-selector">
                        <label for="cpu1Select" style="display: block; font-weight: 600; margin-bottom: 8px; color: #2c3e50; text-align: center;">CPU 1</label>
                        <select id="cpu1Select" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; transition: all 0.3s;">
                            <option value="">Select CPU...</option>
                        </select>
                    </div>
                    <div class="comparison-selector">
                        <label for="cpu2Select" style="display: block; font-weight: 600; margin-bottom: 8px; color: #2c3e50; text-align: center;">CPU 2</label>
                        <select id="cpu2Select" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; transition: all 0.3s;">
                            <option value="">Select CPU...</option>
                        </select>
                    </div>
                </div>
                <div style="text-align: center;">
                    <button id="compareButton" style="padding: 12px 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);" disabled onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(102, 126, 234, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(102, 126, 234, 0.3)';" onclick="this.style.transform='translateY(0)'; setTimeout(() => this.style.transform='translateY(-2px)', 100);">
                        Compare CPUs
                    </button>
                </div>
            </div>
            <div id="comparisonResult" style="display: none;">
                <div class="comparison-table-container" style="max-width: 1200px; margin: 0 auto;">
                    <table class="comparison-table" style="width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
                                <th style="padding: 20px; text-align: left; font-weight: 600; color: #1e293b; font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e2e8f0; width: 25%;">Specification</th>
                                <th id="cpu1NameHeader" style="padding: 20px; text-align: center; font-weight: 600; color: #1e293b; font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e2e8f0; width: 25%;">CPU 1</th>
                                <th id="cpu2NameHeader" style="padding: 20px; text-align: center; font-weight: 600; color: #1e293b; font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e2e8f0; width: 25%;">CPU 2</th>
                                <th style="padding: 20px; text-align: center; font-weight: 600; color: #1e293b; font-size: 0.95em; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e2e8f0; width: 25%;">Difference</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allCpus = [];
        let filteredCpus = [];
        let activeFamilies = new Set();
        let activeCodenames = new Set();

        // Fetch all CPU data
        async function loadData() {
            try {
                const response = await fetch('/api/cpus?limit=1000');
                allCpus = await response.json();
                filteredCpus = allCpus;
                
                updateStats();
                setupFilters();
                updateChart();
                populateComparisonDropdowns();
            } catch (error) {
                document.getElementById('chart').innerHTML = 
                    '<div class="error">Error loading data: ' + error.message + '</div>';
            }
        }

        // Update statistics
        function updateStats() {
            const validCpus = filteredCpus.filter(cpu => cpu.tdp_watts && cpu.cores && cpu.max_turbo_frequency_ghz);
            
            document.getElementById('totalCpus').textContent = filteredCpus.length;
            
            const avgTdp = validCpus.length > 0 
                ? (validCpus.reduce((sum, c) => sum + (c.tdp_watts || 0), 0) / validCpus.length).toFixed(1)
                : '-';
            document.getElementById('avgTdp').textContent = avgTdp;
            
            const avgCores = validCpus.length > 0
                ? (validCpus.reduce((sum, c) => sum + (c.cores || 0), 0) / validCpus.length).toFixed(1)
                : '-';
            document.getElementById('avgCores').textContent = avgCores;
            
            const avgFreq = validCpus.length > 0
                ? (validCpus.reduce((sum, c) => sum + (c.max_turbo_frequency_ghz || 0), 0) / validCpus.length).toFixed(2)
                : '-';
            document.getElementById('avgFreq').textContent = avgFreq;
        }

        // Setup filter chips
        function setupFilters() {
            const families = [...new Set(allCpus.map(cpu => cpu.family).filter(f => f))].sort();
            const codenames = [...new Set(allCpus.map(cpu => cpu.codename).filter(c => c))].sort();

            const familyContainer = document.getElementById('familyFilters');
            familyContainer.innerHTML = '<span class="filter-chip active" data-type="family" data-value="all">All</span>';
            families.forEach(family => {
                const chip = document.createElement('span');
                chip.className = 'filter-chip active';
                chip.textContent = family;
                chip.dataset.type = 'family';
                chip.dataset.value = family;
                chip.onclick = () => toggleFilter('family', family);
                familyContainer.appendChild(chip);
                activeFamilies.add(family);
            });

            const codenameContainer = document.getElementById('codenameFilters');
            codenameContainer.innerHTML = '<span class="filter-chip active" data-type="codename" data-value="all">All</span>';
            codenames.forEach(codename => {
                const chip = document.createElement('span');
                chip.className = 'filter-chip active';
                chip.textContent = codename;
                chip.dataset.type = 'codename';
                chip.dataset.value = codename;
                chip.onclick = () => toggleFilter('codename', codename);
                codenameContainer.appendChild(chip);
                activeCodenames.add(codename);
            });
        }

        // Toggle filter
        function toggleFilter(type, value) {
            if (value === 'all') {
                if (type === 'family') {
                    activeFamilies.clear();
                    document.querySelectorAll('[data-type="family"]').forEach(chip => {
                        chip.classList.add('active');
                        if (chip.dataset.value !== 'all') {
                            activeFamilies.add(chip.dataset.value);
                        }
                    });
                } else {
                    activeCodenames.clear();
                    document.querySelectorAll('[data-type="codename"]').forEach(chip => {
                        chip.classList.add('active');
                        if (chip.dataset.value !== 'all') {
                            activeCodenames.add(chip.dataset.value);
                        }
                    });
                }
            } else {
                const chip = document.querySelector(`[data-type="${type}"][data-value="${value}"]`);
                if (type === 'family') {
                    if (activeFamilies.has(value)) {
                        activeFamilies.delete(value);
                        chip.classList.remove('active');
                    } else {
                        activeFamilies.add(value);
                        chip.classList.add('active');
                    }
                } else {
                    if (activeCodenames.has(value)) {
                        activeCodenames.delete(value);
                        chip.classList.remove('active');
                    } else {
                        activeCodenames.add(value);
                        chip.classList.add('active');
                    }
                }
            }
            applyFilters();
        }

        // Apply filters
        function applyFilters() {
            filteredCpus = allCpus.filter(cpu => {
                const familyMatch = activeFamilies.size === 0 || !cpu.family || activeFamilies.has(cpu.family);
                const codenameMatch = activeCodenames.size === 0 || !cpu.codename || activeCodenames.has(cpu.codename);
                return familyMatch && codenameMatch;
            });
            updateStats();
            updateChart();
        }

        // Update chart
        function updateChart() {
            const xAxis = document.getElementById('xAxis').value;
            const yAxis = document.getElementById('yAxis').value;
            const chartType = document.getElementById('chartType').value;

            const xLabel = document.getElementById('xAxis').options[document.getElementById('xAxis').selectedIndex].text;
            const yLabel = document.getElementById('yAxis').options[document.getElementById('yAxis').selectedIndex].text;

            document.getElementById('chartTitle').textContent = `${yLabel} vs ${xLabel}`;

            // Filter out CPUs with missing data
            const validCpus = filteredCpus.filter(cpu => 
                cpu[xAxis] != null && cpu[yAxis] != null
            );

            if (validCpus.length === 0) {
                document.getElementById('chart').innerHTML = 
                    '<div class="error">No data available for selected parameters</div>';
                return;
            }

            let traces = [];
            let layout = {};

            if (chartType === 'scatter') {
                // Colorblind-friendly color palette (Okabe-Ito inspired)
                const colorPalette = [
                    '#0072B2', // Blue
                    '#E69F00', // Orange
                    '#009E73', // Bluish Green
                    '#D55E00', // Vermillion
                    '#CC79A7', // Reddish Purple
                    '#56B4E9', // Sky Blue
                    '#F0E442', // Yellow
                    '#000000'  // Black
                ];
                
                // Group by family for color coding
                const families = [...new Set(validCpus.map(cpu => cpu.family || 'Unknown'))];
                families.forEach((family, index) => {
                    const familyCpus = validCpus.filter(cpu => (cpu.family || 'Unknown') === family);
                    traces.push({
                        x: familyCpus.map(cpu => cpu[xAxis]),
                        y: familyCpus.map(cpu => cpu[yAxis]),
                        mode: 'markers',
                        type: 'scatter',
                        name: family,
                        text: familyCpus.map(cpu => cpu.cpu_model_name),
                        hovertemplate: '<b>%{text}</b><br>' + 
                                      xLabel + ': %{x}<br>' + 
                                      yLabel + ': %{y}<extra></extra>',
                        marker: {
                            size: 14,
                            opacity: 0.8,
                            color: colorPalette[index % colorPalette.length],
                            line: {
                                width: 1.5,
                                color: '#ffffff'
                            }
                        }
                    });
                });

                layout = {
                    title: {
                        text: `${yLabel} vs ${xLabel}`,
                        font: { size: 18 }
                    },
                    xaxis: { title: xLabel },
                    yaxis: { title: yLabel },
                    hovermode: 'closest',
                    margin: { l: 60, r: 20, t: 60, b: 60 }
                };
            } else if (chartType === 'bar') {
                // Get limit from input (default 25)
                const barLimit = parseInt(document.getElementById('barLimit').value) || 25;
                
                // Sort by y-axis value and take top N for readability
                const sorted = [...validCpus].sort((a, b) => (b[yAxis] || 0) - (a[yAxis] || 0)).slice(0, barLimit);
                
                // Calculate dynamic height based on number of CPUs
                // Base height: 600px for up to 25 CPUs
                // For 25-50: 30px per CPU
                // For 50+: 25px per CPU (more compact but still readable)
                let chartHeight;
                const numCpus = sorted.length;
                if (numCpus <= 25) {
                    chartHeight = 600;
                } else if (numCpus <= 50) {
                    chartHeight = 600 + (numCpus - 25) * 30;
                } else {
                    chartHeight = 600 + 25 * 30 + (numCpus - 50) * 25;
                }
                
                // Set chart container height dynamically
                const chartElement = document.getElementById('chart');
                chartElement.style.height = chartHeight + 'px';
                chartElement.style.minHeight = chartHeight + 'px';
                
                // Group by family for legend
                const families = [...new Set(sorted.map(cpu => {
                    if (!cpu.family) return 'Unknown';
                    if (cpu.family.includes('EPYC')) return 'AMD EPYC';
                    if (cpu.family.includes('Xeon')) return 'Intel Xeon';
                    return cpu.family;
                }))];
                
                // Colorblind-friendly color mapping
                const familyColors = {
                    'AMD EPYC': '#0072B2',  // Blue
                    'Intel Xeon': '#E69F00', // Orange
                    'Unknown': '#7f7f7f'     // Gray
                };
                
                const getColorForFamily = (family) => {
                    if (!family) return familyColors['Unknown'];
                    if (family.includes('EPYC')) return familyColors['AMD EPYC'];
                    if (family.includes('Xeon')) return familyColors['Intel Xeon'];
                    return '#009E73'; // Green for others
                };
                
                // Create separate traces for each family to enable legend
                families.forEach(family => {
                    const familyCpus = sorted.filter(cpu => {
                        if (family === 'Unknown') return !cpu.family;
                        if (family === 'AMD EPYC') return cpu.family && cpu.family.includes('EPYC');
                        if (family === 'Intel Xeon') return cpu.family && cpu.family.includes('Xeon');
                        return cpu.family === family;
                    });
                    
                    if (familyCpus.length > 0) {
                        traces.push({
                            x: familyCpus.map(cpu => cpu[yAxis]),
                            y: familyCpus.map(cpu => cpu.cpu_model_name),
                            type: 'bar',
                            orientation: 'h',
                            name: family,
                            marker: {
                                color: familyColors[family] || getColorForFamily(familyCpus[0].family),
                                line: {
                                    width: 1,
                                    color: '#ffffff'
                                }
                            },
                            text: familyCpus.map(cpu => `${xLabel}: ${cpu[xAxis]}`),
                            hovertemplate: '<b>%{y}</b><br>' + 
                                          yLabel + ': %{x}<br>' + 
                                          '%{text}<extra></extra>'
                        });
                    }
                });

                layout = {
                    title: {
                        text: `Top ${sorted.length} CPUs by ${yLabel}`,
                        font: { size: 18 }
                    },
                    xaxis: { 
                        title: yLabel
                    },
                    yaxis: { 
                        title: 'CPU Model',
                        automargin: true,
                        tickmode: 'linear',
                        tickangle: 0
                    },
                    margin: { l: 250, r: 150, t: 60, b: 60 },
                    showlegend: true,
                    legend: {
                        x: 1.02,
                        y: 1,
                        xanchor: 'left',
                        yanchor: 'top',
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#e2e8f0',
                        borderwidth: 1
                    },
                    height: chartHeight
                };
            } else if (chartType === 'box') {
                // Colorblind-friendly color palette (more vibrant, less pastel)
                const colorPalette = [
                    '#0072B2', // Blue
                    '#E69F00', // Orange
                    '#009E73', // Bluish Green
                    '#D55E00', // Vermillion
                    '#CC79A7', // Reddish Purple
                    '#56B4E9', // Sky Blue
                    '#F0E442', // Yellow
                    '#000000'  // Black
                ];
                
                // Group by family for box plots
                const families = [...new Set(validCpus.map(cpu => cpu.family || 'Unknown'))];
                families.forEach((family, index) => {
                    const familyCpus = validCpus.filter(cpu => (cpu.family || 'Unknown') === family);
                    const color = colorPalette[index % colorPalette.length];
                    traces.push({
                        y: familyCpus.map(cpu => cpu[yAxis]),
                        type: 'box',
                        name: family,
                        boxpoints: 'all',
                        jitter: 0.3,
                        pointpos: -1.8,
                        marker: {
                            size: 8,
                            opacity: 0.8,
                            color: color,
                            line: {
                                width: 1,
                                color: '#ffffff'
                            }
                        },
                        line: {
                            color: color,
                            width: 2.5
                        },
                        fillcolor: color,
                        opacity: 0.6
                    });
                });

                layout = {
                    title: {
                        text: `Distribution of ${yLabel} by Family`,
                        font: { size: 18 }
                    },
                    yaxis: { title: yLabel },
                    xaxis: { 
                        title: 'Family',
                        tickangle: 0
                    },
                    margin: { l: 60, r: 20, t: 60, b: 100 }
                };
            }

            Plotly.newPlot('chart', traces, layout, { responsive: true });
        }

        // CPU Comparison Functions
        function populateComparisonDropdowns() {
            const cpu1Select = document.getElementById('cpu1Select');
            const cpu2Select = document.getElementById('cpu2Select');
            
            // Clear existing options (except first)
            cpu1Select.innerHTML = '<option value="">Select CPU...</option>';
            cpu2Select.innerHTML = '<option value="">Select CPU...</option>';
            
            // Sort CPUs by name for easier selection
            const sortedCpus = [...allCpus].sort((a, b) => 
                (a.cpu_model_name || '').localeCompare(b.cpu_model_name || '')
            );
            
            sortedCpus.forEach(cpu => {
                const option1 = document.createElement('option');
                option1.value = cpu.id;
                option1.textContent = `${cpu.cpu_model_name}${cpu.codename ? ' (' + cpu.codename + ')' : ''}`;
                cpu1Select.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = cpu.id;
                option2.textContent = `${cpu.cpu_model_name}${cpu.codename ? ' (' + cpu.codename + ')' : ''}`;
                cpu2Select.appendChild(option2);
            });
        }

        function compareCPUs() {
            const cpu1Id = parseInt(document.getElementById('cpu1Select').value);
            const cpu2Id = parseInt(document.getElementById('cpu2Select').value);
            
            if (!cpu1Id || !cpu2Id) {
                alert('Please select both CPUs to compare');
                return;
            }
            
            if (cpu1Id === cpu2Id) {
                alert('Please select two different CPUs to compare');
                return;
            }
            
            const cpu1 = allCpus.find(c => c.id === cpu1Id);
            const cpu2 = allCpus.find(c => c.id === cpu2Id);
            
            if (!cpu1 || !cpu2) {
                alert('CPU not found');
                return;
            }
            
            displayComparison(cpu1, cpu2);
        }

        function displayComparison(cpu1, cpu2) {
            const cpu1Name = cpu1.cpu_model_name || 'CPU 1';
            const cpu2Name = cpu2.cpu_model_name || 'CPU 2';
            
            document.getElementById('cpu1NameHeader').textContent = cpu1Name;
            document.getElementById('cpu2NameHeader').textContent = cpu2Name;
            
            const comparisonBody = document.getElementById('comparisonBody');
            comparisonBody.innerHTML = '';
            
            const parameters = [
                { key: 'cpu_model_name', label: 'CPU Model Name', type: 'text' },
                { key: 'codename', label: 'Codename', type: 'text' },
                { key: 'family', label: 'Family', type: 'text' },
                { key: 'cpu_model', label: 'CPU Model', type: 'text' },
                { key: 'cores', label: 'Cores', type: 'number', higher: 'better', format: (v) => v != null ? v : '-' },
                { key: 'threads', label: 'Threads', type: 'number', higher: 'better', format: (v) => v != null ? v : '-' },
                { key: 'max_turbo_frequency_ghz', label: 'Max Turbo Frequency', type: 'number', higher: 'better', unit: 'GHz', format: (v) => v ? v.toFixed(2) : '-' },
                { key: 'l3_cache_mb', label: 'L3 Cache', type: 'number', higher: 'better', unit: 'MB', format: (v) => v ? v.toFixed(1) : '-' },
                { key: 'tdp_watts', label: 'TDP', type: 'number', higher: 'worse', unit: 'W', format: (v) => v || '-' },
                { key: 'launch_year', label: 'Launch Year', type: 'number', higher: 'better', format: (v) => v || '-' },
                { key: 'max_memory_tb', label: 'Max Memory', type: 'number', higher: 'better', unit: 'TB', format: (v) => v ? v.toFixed(2) : '-' }
            ];
            
            parameters.forEach((param, index) => {
                const row = document.createElement('tr');
                const val1 = cpu1[param.key];
                const val2 = cpu2[param.key];
                
                let diffHtml = '';
                let diffClass = '';
                let cell1Style = 'padding: 16px 20px; text-align: center; border-bottom: 1px solid #f1f5f9;';
                let cell2Style = 'padding: 16px 20px; text-align: center; border-bottom: 1px solid #f1f5f9;';
                
                if (param.type === 'number' && val1 != null && val2 != null && param.higher) {
                    const diff = val2 - val1;
                    const percentDiff = val1 !== 0 ? ((diff / val1) * 100).toFixed(1) : 0;
                    
                    if (diff > 0) {
                        const badgeClass = param.higher === 'better' ? 'better' : 'worse';
                        const bgColor = param.higher === 'better' ? '#d1fae5' : '#fee2e2';
                        const textColor = param.higher === 'better' ? '#065f46' : '#991b1b';
                        cell2Style += ` background: ${bgColor};`;
                        diffHtml = `<span style="display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: 600; background: ${bgColor}; color: ${textColor};">+${Math.abs(diff)}${param.unit ? ' ' + param.unit : ''} (+${Math.abs(percentDiff)}%)</span>`;
                    } else if (diff < 0) {
                        const badgeClass = param.higher === 'better' ? 'worse' : 'better';
                        const bgColor = param.higher === 'better' ? '#fee2e2' : '#d1fae5';
                        const textColor = param.higher === 'better' ? '#991b1b' : '#065f46';
                        cell1Style += ` background: ${bgColor};`;
                        diffHtml = `<span style="display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: 600; background: ${bgColor}; color: ${textColor};">${diff}${param.unit ? ' ' + param.unit : ''} (${percentDiff}%)</span>`;
                    } else {
                        diffHtml = '<span style="display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: 600; background: #f1f5f9; color: #475569;">Same</span>';
                    }
                } else if (param.type === 'text') {
                    if (val1 === val2) {
                        diffHtml = '<span style="display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: 600; background: #f1f5f9; color: #475569;">Same</span>';
                    } else {
                        diffHtml = '<span style="display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: 600; background: #fffbeb; color: #d97706;">Different</span>';
                    }
                } else {
                    diffHtml = val1 === val2 ? '<span style="display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: 600; background: #f1f5f9; color: #475569;">Same</span>' : '<span style="display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: 600; background: #fffbeb; color: #d97706;">Different</span>';
                }
                
                const formatValue = param.format || ((v) => v != null ? v : '-');
                const display1 = formatValue(val1);
                const display2 = formatValue(val2);
                const unit1 = (param.unit && display1 !== '-') ? ` ${param.unit}` : '';
                const unit2 = (param.unit && display2 !== '-') ? ` ${param.unit}` : '';
                
                const rowBg = index % 2 === 0 ? 'background: #ffffff;' : 'background: #f8fafc;';
                
                row.innerHTML = `
                    <td style="padding: 16px 20px; font-weight: 600; color: #334155; border-bottom: 1px solid #f1f5f9; ${rowBg}">${param.label}</td>
                    <td style="${cell1Style} ${rowBg}"><span style="color: #1e293b; font-size: 1em; font-weight: 500;">${display1}${unit1}</span></td>
                    <td style="${cell2Style} ${rowBg}"><span style="color: #1e293b; font-size: 1em; font-weight: 500;">${display2}${unit2}</span></td>
                    <td style="padding: 16px 20px; text-align: center; border-bottom: 1px solid #f1f5f9; ${rowBg}">${diffHtml}</td>
                `;
                comparisonBody.appendChild(row);
            });
            
            document.getElementById('comparisonResult').style.display = 'block';
        }

        // Event listeners
        document.getElementById('xAxis').addEventListener('change', updateChart);
        document.getElementById('yAxis').addEventListener('change', updateChart);
        document.getElementById('chartType').addEventListener('change', function() {
            const barLimitGroup = document.getElementById('barLimitGroup');
            if (this.value === 'bar') {
                barLimitGroup.style.display = 'block';
            } else {
                barLimitGroup.style.display = 'none';
            }
            updateChart();
        });
        document.getElementById('barLimit').addEventListener('change', updateChart);
        document.getElementById('barLimit').addEventListener('input', updateChart);
        
        document.getElementById('cpu1Select').addEventListener('change', function() {
            const cpu1 = this.value;
            const cpu2 = document.getElementById('cpu2Select').value;
            const compareButton = document.getElementById('compareButton');
            compareButton.disabled = !cpu1 || !cpu2;
            if (!compareButton.disabled) {
                compareButton.style.opacity = '1';
                compareButton.style.cursor = 'pointer';
            } else {
                compareButton.style.opacity = '0.5';
                compareButton.style.cursor = 'not-allowed';
            }
        });

        document.getElementById('cpu2Select').addEventListener('change', function() {
            const cpu1 = document.getElementById('cpu1Select').value;
            const cpu2 = this.value;
            const compareButton = document.getElementById('compareButton');
            compareButton.disabled = !cpu1 || !cpu2;
            if (!compareButton.disabled) {
                compareButton.style.opacity = '1';
                compareButton.style.cursor = 'pointer';
            } else {
                compareButton.style.opacity = '0.5';
                compareButton.style.cursor = 'not-allowed';
            }
        });
        
        // Set initial button state
        document.getElementById('compareButton').style.opacity = '0.5';
        document.getElementById('compareButton').style.cursor = 'not-allowed';
        
        document.getElementById('compareButton').addEventListener('click', compareCPUs);

        // Initialize
        loadData();
    </script>
</body>
</html>

